<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾é£Ÿå†³ç­–åŠ©æ‰‹ - æ™ºèƒ½ä»£ç†åŠ è½½ä¸­...</title>
    <link rel="stylesheet" href="proxy.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”</text></svg>">
    <style>
        /* ä¸»å®¹å™¨æ ·å¼ */
        #app-container {
            min-height: 100vh;
            position: relative;
        }
        
        /* åŠ è½½å±å¹•æ ·å¼ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 25px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #loading-screen h2 {
            color: white;
            font-size: 2em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }
        
        #loading-screen p {
            color: rgba(255, 255, 255, 0.85);
            max-width: 500px;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .loading-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            width: 90%;
            max-width: 500px;
        }
        
        .step-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .step-item.completed {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 0.9em;
        }
        
        .step-item.completed .step-icon {
            background: #48bb78;
        }
        
        .step-text {
            flex: 1;
        }
        
        .progress-container {
            width: 90%;
            max-width: 500px;
            margin-top: 20px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* é”™è¯¯å±å¹•æ ·å¼ */
        #error-screen {
            display: none;
            padding: 60px 20px;
            text-align: center;
            background: white;
            min-height: 100vh;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .error-icon {
            font-size: 5em;
            margin-bottom: 25px;
            color: #f56565;
        }
        
        .error-title {
            font-size: 2.2em;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .error-message {
            color: #718096;
            font-size: 1.1em;
            line-height: 1.7;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .error-solutions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .solution-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            text-align: left;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .solution-card:hover {
            border-color: #667eea;
            background: white;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .solution-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }
        
        .solution-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .solution-desc {
            color: #718096;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
              /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .nav-bar.scrolled {
            padding: 10px 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }
        
        .nav-title {
            font-weight: 600;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .nav-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .nav-btn.secondary {
            background: #edf2f7;
            color: #4a5568;
        }
        
        .nav-btn.secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Toastæç¤ºæ ·å¼ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(45, 55, 72, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* é…ç½®è¯´æ˜æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-subtitle {
            color: #718096;
            line-height: 1.6;
        }
        
        .modal-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .code-block {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }
        
        .code-block code {
            font-family: 'Courier New', monospace;
            color: #2d3748;
            line-height: 1.5;
        }
        
        .modal-footer {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        #content-container {
            padding-top: 80px;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        /* æ€§èƒ½ç›‘æ§ */
        .perf-monitor {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            z-index: 999;
            font-size: 0.85em;
            border: 1px solid #e2e8f0;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .perf-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        .perf-label {
            font-weight: 500;
        }
        
        .perf-value {
            font-family: 'Courier New', monospace;
            color: #667eea;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #loading-screen h2 {
                font-size: 1.6em;
            }
            
            #loading-screen p {
                font-size: 1em;
                padding: 0 20px;
            }
            
            .nav-bar {
                padding: 12px 15px;
                flex-wrap: wrap;
            }
            
            .nav-title {
                font-size: 1.1em;
                order: 1;
                flex: 1;
            }
            
            .nav-actions {
                order: 2;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .error-solutions {
                grid-template-columns: 1fr;
            }
            
            #content-container {
                padding-top: 100px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-btn .btn-text {
                display: none;
            }
            
            .nav-btn {
                padding: 10px;
                border-radius: 50%;
                width: 45px;
                height: 45px;
                justify-content: center;
            }
            
            .modal-title {
                font-size: 1.5em;
            }
            
            .error-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
      <!-- å¯¼èˆªæ  -->
    <div class="nav-bar" id="navBar">
        <div class="nav-title" id="pageTitle">
            <span>ğŸ½ï¸</span>
            <span>ç¾é£Ÿå†³ç­–åŠ©æ‰‹</span>
        </div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="refreshContent()">
                <span>ğŸ”„</span>
                <span class="btn-text">åˆ·æ–°</span>
            </button>
            <button class="nav-btn secondary" onclick="showOriginal()">
                <span>ğŸŒ</span>
                <span class="btn-text">åŸç½‘ç«™</span>
            </button>
            <button class="nav-btn secondary" onclick="goHome()">
                <span>ğŸ </span>
                <span class="btn-text">é¦–é¡µ</span>
            </button>
            <button class="nav-btn secondary" onclick="togglePerfMonitor()">
                <span>ğŸ“Š</span>
                <span class="btn-text">æ€§èƒ½</span>
            </button>
        </div>
    </div>

    <!-- åŠ è½½å±å¹• -->
    <div id="loading-screen">
        <div class="loader"></div>
        <h2>æ­£åœ¨åŠ è½½ç¾é£Ÿå†³ç­–åŠ©æ‰‹...</h2>
        <p>è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ€ä½³çš„ç¾é£Ÿé€‰æ‹©ä½“éªŒ</p >
        
        <div class="loading-steps">
            <div class="step-item" id="step1">
                <div class="step-icon">1</div>
                <div class="step-text">è¿æ¥åˆ°æœåŠ¡å™¨</div>
            </div>
            <div class="step-item" id="step2">
                <div class="step-icon">2</div>
                <div class="step-text">ä¸‹è½½é¡µé¢å†…å®¹</div>
            </div>
            <div class="step-item" id="step3">
                <div class="step-icon">3</div>
                <div class="step-text">å¤„ç†é¡µé¢èµ„æº</div>
            </div>
            <div class="step-item" id="step4">
                <div class="step-icon">4</div>
                <div class="step-text">åˆå§‹åŒ–äº¤äº’åŠŸèƒ½</div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-text">
                <span>åŠ è½½è¿›åº¦</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div style="margin-top: 30px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em; text-align: center;">
            <p>å¦‚æœåŠ è½½æ—¶é—´è¾ƒé•¿ï¼Œè¯·å°è¯• <a href=" " style="color: white; text-decoration: underline;">å¤‡ç”¨æ–¹æ¡ˆ</a ></p >
        </div>
    </div>

    <!-- é”™è¯¯å±å¹• -->
    <div id="error-screen">
        <div class="error-icon">ğŸ˜Ÿ</div>
        <div class="error-title">åŠ è½½å¤±è´¥</div>
        <div class="error-message" id="error-message">
            æ— æ³•è¿æ¥åˆ°ç¾é£Ÿå†³ç­–åŠ©æ‰‹ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚
        </div>
        
        <div class="error-solutions">
            <div class="solution-card">
                <div class="solution-icon">ğŸ”„</div>
                <div class="solution-title">é‡æ–°åŠ è½½</div>
                <div class="solution-desc">ç½‘ç»œé—®é¢˜å¯èƒ½å¯¼è‡´åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡æ–°è¿æ¥</div>
                <button class="nav-btn" onclick="refreshContent()" style="width: 100%;">
                    é‡æ–°åŠ è½½
                </button>
            </div>
            
            <div class="solution-card">
                <div class="solution-icon">ğŸ›¡ï¸</div>
                <div class="solution-title">ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ</div>
                <div class="solution-desc">å°è¯•ä½¿ç”¨æ›´ç¨³å®šçš„iframeåµŒå…¥æ–¹å¼</div>
                <button class="nav-btn secondary" onclick="window.location.href='iframe-proxy.html'" style="width: 100%;">
                    å¤‡ç”¨è®¿é—®
                </button>
            </div>
            
            <div class="solution-card">
                <div class="solution-icon">âš¡</div>
                <div class="solution-title">ç›´æ¥è®¿é—®</div>
                <div class="solution-desc">é…ç½®hostsæ–‡ä»¶è·å¾—æœ€ä½³ä½“éªŒ</div>
                <button class="nav-btn secondary" onclick="showInstructions()" style="width: 100%; background: #ed8936;">
                    æŸ¥çœ‹é…ç½®æ–¹æ³•
                </button>
            </div>
        </div>
        
        <div style="margin-top: 40px;">
            <p style="color: #718096;">é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Ÿ</p >
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                <button class="nav-btn secondary" onclick="goHome()">
                    è¿”å›é¦–é¡µ
                </button>
                <button class="nav-btn secondary" onclick="copyErrorReport()">
                    å¤åˆ¶é”™è¯¯æŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹å®¹å™¨ -->
    <div id="content-container"></div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <!-- æ€§èƒ½ç›‘æ§ -->
    <div class="perf-monitor" id="perfMonitor">
        <div class="perf-item">
            <span class="perf-label">åŠ è½½æ—¶é—´:</span>
            <span class="perf-value" id="loadTime">0ms</span>
        </div>
        <div class="perf-item">
            <span class="perf-label">èµ„æºæ•°é‡:</span>
            <span class="perf-value" id="resourceCount">0</span>
        </div>
        <div class="perf-item">
            <span class="perf-label">å†…å­˜ä½¿ç”¨:</span>
            <span class="perf-value" id="memoryUsage">--</span>
        </div>
        <div class="perf-item">
            <span class="perf-label">ä»£ç†çŠ¶æ€:</span>
            <span class="perf-value" id="proxyStatus">æ­£å¸¸</span>
        </div>
    </div>

    <!-- é…ç½®è¯´æ˜æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="instructionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span>ğŸ“</span>
                    <span>æœ€ä½³ä½“éªŒé…ç½®æŒ‡å—</span>
                </div>
                <div class="modal-subtitle">
                    é€šè¿‡ä¿®æ”¹hostsæ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç›´æ¥è®¿é—®åŸç½‘ç«™ï¼Œè·å¾—æœ€ä½³ä½“éªŒå’Œæœ€å¿«é€Ÿåº¦ã€‚
                </div>
            </div>
            
            <div class="modal-section">
                <div class="section-title">Windows ç³»ç»Ÿé…ç½®æ–¹æ³•</div>
                <ol style="margin-left: 20px; line-height: 1.8; color: #4a5568;">
                    <li><strong>ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤æç¤ºç¬¦</strong>
                        <ul style="margin: 8px 0 8px 20px; color: #718096;">
                            <li>å³é”®ç‚¹å‡»å¼€å§‹èœå•</li>
                            <li>é€‰æ‹©"Windows PowerShell (ç®¡ç†å‘˜)"æˆ–"å‘½ä»¤æç¤ºç¬¦ (ç®¡ç†å‘˜)"</li>
                        </ul>
                    </li>
                    <li><strong>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</strong>
                        <div class="code-block">
                            <code># æ·»åŠ hostsè®°å½•
echo 185.199.108.153 dig.ua >> C:\Windows\System32\drivers\etc\hosts
echo 185.199.108.153 www.dig.ua >> C:\Windows\System32\drivers\etc\hosts

# åˆ·æ–°DNSç¼“å­˜
ipconfig /flushdns</code>
                        </div>
                    </li>
                    <li><strong>éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š</strong>
                        <div class="code-block">
                            <code># æµ‹è¯•åŸŸåè§£æ
ping dig.ua

# åº”è¯¥æ˜¾ç¤ºï¼šæ­£åœ¨ Ping dig.ua [185.199.108.153] ...</code>
                        </div>
                    </li>
                </ol>
            </div>
             <div class="modal-section">
                <div class="section-title">macOS / Linux ç³»ç»Ÿé…ç½®æ–¹æ³•</div>
                <div class="code-block">
                    <code># ç¼–è¾‘hostsæ–‡ä»¶ï¼ˆéœ€è¦sudoæƒé™ï¼‰
sudo nano /etc/hosts

# åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š
185.199.108.153 dig.ua
185.199.108.153 www.dig.ua

# ä¿å­˜æ–‡ä»¶ï¼ˆCtrl+O, Enter, Ctrl+Xï¼‰
# åˆ·æ–°DNSç¼“å­˜ï¼ˆmacOSï¼‰
sudo killall -HUP mDNSResponder</code>
                </div>
            </div>
            
            <div class="modal-section">
                <div class="section-title">é…ç½®åçš„ä¼˜åŠ¿</div>
                <ul style="margin-left: 20px; line-height: 1.8; color: #4a5568;">
                    <li>âš¡ <strong>æ›´å¿«çš„åŠ è½½é€Ÿåº¦</strong>ï¼šæ— éœ€ä»£ç†ä¸­è½¬</li>
                    <li>ğŸ¯ <strong>å®Œæ•´çš„åŠŸèƒ½ä½“éªŒ</strong>ï¼šæ— åŠŸèƒ½é™åˆ¶</li>
                    <li>ğŸ”’ <strong>æ›´å¥½çš„ç¨³å®šæ€§</strong>ï¼šä¸å—ä»£ç†æœåŠ¡å½±å“</li>
                    <li>ğŸ“± <strong>å…¨å¹³å°æ”¯æŒ</strong>ï¼šç”µè„‘ã€æ‰‹æœºéƒ½èƒ½ç”¨</li>
                </ul>
            </div>
            
            <div class="modal-footer">
                <button class="nav-btn" onclick="hideInstructions()" style="width: 200px;">
                    å…³é—­æŒ‡å—
                </button>
                <div style="margin-top: 15px;">
                    <a href=" " style="color: #667eea; text-decoration: none; font-weight: 500;">
                        ğŸ‰ ç«‹å³å°è¯•ç›´æ¥è®¿é—®
                    </a >
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½®å¸¸é‡ ==========
        const CONFIG = {
            targetUrl: 'http://dig.ua',
            retryCount: 3,
            retryDelay: 2000,
            timeout: 20000,
            enableCache: true,
            cacheKey: 'food-decider-cache-v1',
            cacheTTL: 3600000 // 1å°æ—¶
        };

        // ========== çŠ¶æ€ç®¡ç† ==========
        let currentState = {
            loaded: false,
            retryCount: 0,
            startTime: Date.now(),
            resourceCount: 0,
            error: null
        };

        // ========== ä¸»åŠ è½½å‡½æ•° ==========
        async function loadContent() {
            currentState.startTime = Date.now();
            updateProgress(10, 'æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...');
            updateStep(1);
            
            try {
                // å°è¯•ä»ç¼“å­˜åŠ è½½
                if (CONFIG.enableCache) {
                    const cached = await loadFromCache();
                    if (cached) {
                        updateProgress(30, 'ä»ç¼“å­˜åŠ è½½å†…å®¹...');
                        await processAndDisplayHTML(cached);
                        showToast('ä»ç¼“å­˜åŠ è½½æˆåŠŸï¼');
                        return;
                    }
                }
                
                // ä»ç½‘ç»œåŠ è½½
                updateProgress(20, 'ä¸‹è½½é¡µé¢å†…å®¹...');
                updateStep(2);
                const html = await fetchWithRetry(CONFIG.targetUrl);
                
                // ç¼“å­˜å†…å®¹
                if (CONFIG.enableCache) {
                    await saveToCache(html);
                }
                
                updateProgress(50, 'å¤„ç†é¡µé¢èµ„æº...');
                updateStep(3);
                await processAndDisplayHTML(html);
                
                updateProgress(90, 'åˆå§‹åŒ–äº¤äº’åŠŸèƒ½...');
                updateStep(4);
                await initPageInteractions();
                
                updateProgress(100, 'åŠ è½½å®Œæˆï¼');
                
                // æ˜¾ç¤ºé¡µé¢
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        showToast('ç¾é£Ÿå†³ç­–åŠ©æ‰‹åŠ è½½å®Œæˆï¼');
                        updatePerformanceStats();
                    }, 500);
                }, 500);
                
            } catch (error) {
                currentState.error = error;
                showError(`åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // ========== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==========
        
        // å¸¦é‡è¯•çš„fetch
        async function fetchWithRetry(url) {
            for (let i = 0; i < CONFIG.retryCount; i++) {
                try {
                    const progress = 20 + (i * 10);
                    updateProgress(progress, `å°è¯•è¿æ¥ä¸­ (${i + 1}/${CONFIG.retryCount})...`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), CONFIG.timeout);
                    
                    const response = await fetch(url, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'text/html',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.text();
                    
                } catch (error) {
                    if (i === CONFIG.retryCount - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay));
                }
            }
        }

        // å¤„ç†å¹¶æ˜¾ç¤ºHTML
        async function processAndDisplayHTML(html) {
            // åˆ›å»ºä¸´æ—¶å®¹å™¨
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // æ›¿æ¢èµ„æºé“¾æ¥
            replaceResourceLinks(tempDiv);
            
            // æ¸…ç†ä¸éœ€è¦çš„å…ƒç´ 
            cleanupUnwantedElements(tempDiv);
            
            // æ³¨å…¥ä»£ç†æ§åˆ¶è„šæœ¬
            injectProxyScripts(tempDiv);
            
            // æ˜¾ç¤ºå†…å®¹
            document.getElementById('content-container').innerHTML = tempDiv.innerHTML;
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const title = tempDiv.querySelector('title')?.textContent || 'ç¾é£Ÿå†³ç­–åŠ©æ‰‹';
            document.title = title;
            document.getElementById('pageTitle').innerHTML = `<span>ğŸ½ï¸</span><span>${title}</span>`;
            
            // ç­‰å¾…èµ„æºåŠ è½½
            await waitForResources();
        }

        // æ›¿æ¢èµ„æºé“¾æ¥
        function replaceResourceLinks(container) {
            const attributes = {
                'a': 'href',
                'link': 'href',
                'script': 'src',
                'img': 'src',
                'iframe': 'src',
                'source': 'src',
                'video': 'src',
                'audio': 'src',
                'form': 'action'
            };
            
            for (const [tag, attr] of Object.entries(attributes)) {
                container.querySelectorAll(tag).forEach(element => {
                    const value = element.getAttribute(attr);
                    if (value && value.startsWith('/')) {
                        element.setAttribute(attr, CONFIG.targetUrl + value);
                        currentState.resourceCount++;
                    }
                });
            }
            
            // å¤„ç†CSSä¸­çš„url()
            container.querySelectorAll('style').forEach(style => {
                style.textContent = style.textContent.replace(
                    /url\(\s*['"]?\/([^'")]*)['"]?\s*\)/g,
                    `url(${CONFIG.targetUrl}/$1)`
                );
            });
        }

        // æ¸…ç†ä¸éœ€è¦çš„å…ƒç´ 
        function cleanupUnwantedElements(container) {
            // ç§»é™¤å¯èƒ½å¼•èµ·é—®é¢˜çš„è„šæœ¬
            container.querySelectorAll('script[src*="analytics"], script[src*="tracking"], script[src*="ads"]').forEach(s => s.remove());
            
            // ç§»é™¤ä¸éœ€è¦çš„metaæ ‡ç­¾
            container.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(m => m.remove());
        }

        // æ³¨å…¥ä»£ç†æ§åˆ¶è„šæœ¬
        function injectProxyScripts(container) {
            const proxyScript = document.createElement('script');
            proxyScript.textContent = `
                // æ‹¦æˆªé“¾æ¥ç‚¹å‡»
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.includes('${CONFIG.targetUrl}')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // å¦‚æœæ˜¯ç«™å†…é“¾æ¥ï¼Œé‡æ–°åŠ è½½å†…å®¹
                        if (link.href.startsWith('${CONFIG.targetUrl}')) {
                            window.location.hash = link.href;
                            showToast('æ­£åœ¨åŠ è½½æ–°é¡µé¢...');
                            setTimeout(() => window.location.reload(), 100);
                        }
                    }
                });
                
                // æ‹¦æˆªè¡¨å•æäº¤
                document.addEventListener('submit', function(e) {
                    const form = e.target;
                    if (form.action && form.action.includes('${CONFIG.targetUrl}')) {
                        showToast('è¡¨å•æäº¤å·²é‡å®šå‘åˆ°ä»£ç†...');
                    }
                });
                
                // ä¿®æ”¹æ‰€æœ‰é“¾æ¥çš„target
                document.querySelectorAll('a[href^="${CONFIG.targetUrl}"]').forEach(link => {
                    link.target = '_self';
                });
            `;
            container.appendChild(proxyScript);
        }     
              // ç­‰å¾…èµ„æºåŠ è½½
        function waitForResources() {
            return new Promise(resolve => {
                const images = document.querySelectorAll('img');
                let loaded = 0;
                const total = images.length;
                
                if (total === 0) {
                    resolve();
                    return;
                }
                
                const checkProgress = () => {
                    const progress = 50 + Math.floor((loaded / total) * 30);
                    updateProgress(progress, \`åŠ è½½å›¾ç‰‡ (\${loaded}/\${total})...\`);
                    
                    if (loaded === total) {
                        resolve();
                    }
                };
                
                images.forEach(img => {
                    if (img.complete) {
                        loaded++;
                        checkProgress();
                    } else {
                        img.onload = img.onerror = () => {
                            loaded++;
                            checkProgress();
                        };
                    }
                });
                
                // è¶…æ—¶å¤„ç†
                setTimeout(resolve, 5000);
            });
        }

        // åˆå§‹åŒ–é¡µé¢äº¤äº’
        async function initPageInteractions() {
            // ç›‘å¬æ»šåŠ¨ï¼Œæ›´æ–°å¯¼èˆªæ æ ·å¼
            window.addEventListener('scroll', () => {
                const navBar = document.getElementById('navBar');
                if (window.scrollY > 50) {
                    navBar.classList.add('scrolled');
                } else {
                    navBar.classList.remove('scrolled');
                }
            });
            
            // åˆå§‹åŒ–æ‰€æœ‰å·¥å…·æç¤º
            initTooltips();
        }

        // ========== å·¥å…·å‡½æ•° ==========
        
        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            
            const loadingText = document.querySelector('#loading-screen p');
            if (loadingText && message) {
                loadingText.textContent = message;
            }
        }

        function updateStep(step) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById('step' + i);
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.remove('completed');
                }
            }
        }

        function showError(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function refreshContent() {
            // æ¸…é™¤ç¼“å­˜
            if (CONFIG.enableCache) {
                localStorage.removeItem(CONFIG.cacheKey);
            }
            
            // é‡æ–°åŠ è½½
            window.location.reload();
        }

        function showOriginal() {
            window.open(CONFIG.targetUrl, '_blank');
        }

        function goHome() {
            window.location.href = '../index.html';
        }

        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'flex';
            document.getElementById('instructionsModal').scrollTop = 0;
        }

        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }

        function togglePerfMonitor() {
            const monitor = document.getElementById('perfMonitor');
            monitor.style.display = monitor.style.display === 'none' ? 'block' : 'none';
        }

        function updatePerformanceStats() {
            const loadTime = Date.now() - currentState.startTime;
            document.getElementById('loadTime').textContent = loadTime + 'ms';
            document.getElementById('resourceCount').textContent = currentState.resourceCount;
            
            // å°è¯•è·å–å†…å­˜ä¿¡æ¯ï¼ˆä»…é™éƒ¨åˆ†æµè§ˆå™¨ï¼‰
            if (performance.memory) {
                const memory = performance.memory;
                const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                const totalMB = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                document.getElementById('memoryUsage').textContent = usedMB + '/' + totalMB + 'MB';
            }
        }

        function copyErrorReport() {
            const report = \`é”™è¯¯æŠ¥å‘Šï¼š
æ—¶é—´: \${new Date().toLocaleString()}
URL: \${window.location.href}
é”™è¯¯ä¿¡æ¯: \${currentState.error?.message || 'æœªçŸ¥é”™è¯¯'}
ç”¨æˆ·ä»£ç†: \${navigator.userAgent}
            \`;
            
            navigator.clipboard.writeText(report)
                .then(() => showToast('é”™è¯¯æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
                .catch(() => prompt('è¯·æ‰‹åŠ¨å¤åˆ¶é”™è¯¯æŠ¥å‘Šï¼š', report));
        }

        // ========== ç¼“å­˜åŠŸèƒ½ ==========
        
        async function loadFromCache() {
            try {
                const cached = localStorage.getItem(CONFIG.cacheKey);
                if (!cached) return null;
                
                const { html, timestamp } = JSON.parse(cached);
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
                if (Date.now() - timestamp > CONFIG.cacheTTL) {
                    localStorage.removeItem(CONFIG.cacheKey);
                    return null;
                }
                
                return html;
            } catch (error) {
                console.warn('ç¼“å­˜è¯»å–å¤±è´¥:', error);
                return null;
            }
        }

        async function saveToCache(html) {
            try {
                const cacheData = {
                    html: html,
                    timestamp: Date.now()
                };
                localStorage.setItem(CONFIG.cacheKey, JSON.stringify(cacheData));
            } catch (error) {
                console.warn('ç¼“å­˜ä¿å­˜å¤±è´¥:', error);
            }
        }

        // ========== åˆå§‹åŒ–å·¥å…·æç¤º ==========
        function initTooltips() {
            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ æç¤º
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const text = btn.querySelector('.btn-text')?.textContent || '';
                if (text) {
                    btn.title = text;
                }
            });
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½å†…å®¹
        document.addEventListener('DOMContentLoaded', loadContent);

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'r':
                case 'R':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        refreshContent();
                    }
                    break;
                case 'Escape':
                    hideInstructions();
                    break;
                case 'F1':
                    e.preventDefault();
                    showInstructions();
                    break;
                case 'F5':
                    refreshContent();
                    break;
                case '1':
                    goHome();
                    break;
                case '2':
                    showOriginal();
                    break;
            }
        });

        // å¯¼å‡ºåˆ°å…¨å±€
        window.refreshContent = refreshContent;
        window.showOriginal = showOriginal;
        window.goHome = goHome;
        window.showInstructions = showInstructions;
        window.hideInstructions = hideInstructions;
        window.togglePerfMonitor = togglePerfMonitor;
    </script>
</body>
</html>
