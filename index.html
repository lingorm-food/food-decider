<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©åƒä»€ä¹ˆ - ç¾é£Ÿå†³ç­–åŠ©æ‰‹</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* å¤´éƒ¨ */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        main {
            padding: 25px;
        }
        
        section {
            margin-bottom: 25px;
        }
        
        h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.3rem;
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .tag {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .tag:hover {
            background: #e0e0e0;
        }
        
        .tag.selected {
            background: #4CAF50;
            color: white;
            border-color: #388E3C;
        }
        
        /* æŒ‰é’® */
        .main-button {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            transition: transform 0.3s;
        }
        
        .main-button:hover {
            transform: translateY(-3px);
        }
        
        /* ç»“æœåŒºåŸŸ */
        .result-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-name {
            font-size: 2rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        /* å†å²è®°å½• */
        .history-item {
            padding: 10px 15px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            border-left: 4px solid #4CAF50;
        }
        
        .history-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .container {
                border-radius: 10px;
            }
            
            header h1 {
                font-size: 1.7rem;
            }
            
            .main-button {
                padding: 12px 30px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</h1>
            <p>æ™ºèƒ½å†³ç­–åŠ©æ‰‹ Â· å‘Šåˆ«é€‰æ‹©å›°éš¾</p >
        </header>
        
        <main>
            <!-- åå¥½é€‰æ‹© -->
            <section>
                <h2>ğŸ“‹ é€‰æ‹©åå¥½</h2>
                <p>é€‰æ‹©æ ‡ç­¾ï¼Œä¼˜å…ˆæ¨èåŒ¹é…çš„é¤å…</p >
                <div class="tags" id="tagContainer"></div>
            </section>
            
            <!-- å†³ç­–æŒ‰é’® -->
            <section style="text-align: center;">
                <button class="main-button" id="decideButton">ğŸ² å¸®æˆ‘å†³å®šï¼</button>
            </section>
            
            <!-- ç»“æœå±•ç¤º -->
            <section>
                <div class="result-box" id="resultBox">
                    <div class="result-name" id="resultName">...</div>
                    <div id="resultTags"></div>
                    <button class="tag" onclick="pickRandom()" style="margin-top: 15px; background: rgba(255,255,255,0.2); color: white;">
                        ğŸ”„ é‡æ–°é€‰æ‹©
                    </button>
                </div>
            </section>
            
            <!-- å†å²è®°å½• -->
            <section>
                <h2>ğŸ“Š é€‰æ‹©å†å²</h2>
                <div id="historyList"></div>
            </section>
        </main>
        
        <footer style="text-align: center; padding: 15px; color: #666; font-size: 0.9rem;">
            <p>åŸºäºåŠ¨æ€æƒé‡ç®—æ³• Â· æ•°æ®æœ¬åœ°ä¿å­˜</p >
        </footer>
    </div>
    
    <script>
    // ========== æ•°æ®åˆå§‹åŒ– ==========
    console.log("=== ç¾é£Ÿå†³ç­–åŠ©æ‰‹å¯åŠ¨ ===");
    
    // å¯ç”¨æ ‡ç­¾
    const availableTags = ["ä¾¿å®œ", "å¿«é¤", "å¤–å–", "è¾£", "å¥åº·", "é¢é£Ÿ", "ç±³é¥­"];
    
    // é¤å…æ•°æ®
    let restaurants = [
        { id: 1, name: "é£Ÿå ‚ä¸€æ¥¼", tags: ["ä¾¿å®œ", "å¥åº·", "ç±³é¥­"], weight: 10, count: 0 },
        { id: 2, name: "éº»è¾£çƒ«", tags: ["è¾£", "å¤–å–"], weight: 10, count: 0 },
        { id: 3, name: "é»„ç„–é¸¡", tags: ["å¤–å–", "ç±³é¥­"], weight: 10, count: 0 },
        { id: 4, name: "æ²™å¿å°åƒ", tags: ["ä¾¿å®œ", "å¿«é¤"], weight: 10, count: 0 },
        { id: 5, name: "éº¦å½“åŠ³", tags: ["å¿«é¤", "å¤–å–"], weight: 10, count: 0 },
        { id: 6, name: "ç‰›è‚‰é¢", tags: ["é¢é£Ÿ", "è¾£"], weight: 10, count: 0 },
        { id: 7, name: "é¥ºå­é¦†", tags: ["é¢é£Ÿ", "ä¾¿å®œ"], weight: 10, count: 0 },
        { id: 8, name: "ç‚’é¥­åº—", tags: ["ç±³é¥­", "å¿«é¤"], weight: 10, count: 0 }
    ];
    
    // ç”¨æˆ·çŠ¶æ€
    let selectedTags = [];
    let history = [];
    
    // ========== å·¥å…·å‡½æ•° ==========
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
    function loadData() {
        try {
            const saved = localStorage.getItem('foodData');
            if (saved) {
                const data = JSON.parse(saved);
                restaurants = data.restaurants || restaurants;
                history = data.history || [];
                console.log("åŠ è½½ä¿å­˜çš„æ•°æ®");
            }
        } catch (e) {
            console.log("ä½¿ç”¨é»˜è®¤æ•°æ®");
        }
    }
    
    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveData() {
        try {
            const data = {
                restaurants: restaurants,
                history: history
            };
            localStorage.setItem('foodData', JSON.stringify(data));
            console.log("æ•°æ®å·²ä¿å­˜");
        } catch (e) {
            console.log("ä¿å­˜å¤±è´¥:", e);
        }
    }
    
    // è·å–æœ€è¿‘é€‰æ‹©çš„é¤å…ï¼ˆé¿å…é‡å¤ï¼‰
    function getRecentChoices() {
        return history.slice(-3).map(item => item.id);
    }
    
    // ========== æ ¸å¿ƒç®—æ³• ==========

// å¸¦æƒé‡çš„éšæœºé€‰æ‹©
function weightedRandomSelection() {
    // 1. æ ¹æ®æ ‡ç­¾ç­›é€‰
    let candidates = restaurants;
    if (selectedTags.length > 0) {
        candidates = restaurants.filter(r =>
            selectedTags.some(tag => r.tags.includes(tag))
        );
        if (candidates.length === 0) {
            candidates = restaurants;
        }
    }
    
    // 2. æ’é™¤æœ€è¿‘é€‰æ‹©çš„
    const recent = getRecentChoices();
    let available = candidates.filter(r => !recent.includes(r.id));
    if (available.length === 0) {
        available = candidates;
    }
    
    // 3. è®¡ç®—æ€»æƒé‡
    const totalWeight = available.reduce((sum, r) => sum + r.weight, 0);
    if (totalWeight <= 0) {
        return available[0] || restaurants[0];
    }
    
    // 4. åŠ æƒéšæœºé€‰æ‹©
    let random = Math.random() * totalWeight;
    for (const r of available) {
        random -= r.weight;
        if (random <= 0) {
            return r;
        }
    }
    
    return available[0];
}

// æ›´æ–°æƒé‡
function updateWeights(selected) {
    // é™ä½è¢«é€‰ä¸­çš„æƒé‡
    selected.weight = Math.max(1, selected.weight * 0.7);
    selected.count++;
    
    // æé«˜å…¶ä»–é¤å…çš„æƒé‡
    restaurants.forEach(r => {
        if (r.id !== selected.id) {
            r.weight = Math.min(20, r.weight * 1.05);
        }
    });
}

// ========== ç•Œé¢å‡½æ•° ==========

// åˆå§‹åŒ–æ ‡ç­¾
function initTags() {
    const container = document.getElementById('tagContainer');
    container.innerHTML = availableTags.map(tag => `
        <div class="tag ${selectedTags.includes(tag) ? 'selected' : ''}" 
             onclick="toggleTag('${tag}')">
            ${tag}
        </div>
    `).join('');
}

// åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
function toggleTag(tag) {
    const index = selectedTags.indexOf(tag);
    if (index === -1) {
        selectedTags.push(tag);
    } else {
        selectedTags.splice(index, 1);
    }
    initTags();
    console.log("é€‰ä¸­æ ‡ç­¾:", selectedTags);
}

        // éšæœºé€‰æ‹©ä¸»å‡½æ•°
        function pickRandom() {
            console.log("å¼€å§‹éšæœºé€‰æ‹©");
            
            // æ‰§è¡Œé€‰æ‹©
            const selected = weightedRandomSelection();
            console.log("é€‰æ‹©äº†:", selected.name);
            
            // æ›´æ–°æ•°æ®
            updateWeights(selected);
            
            // æ·»åŠ åˆ°å†å²
            history.push({
                id: selected.id,
                name: selected.name,
                time: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString()
            });
            
            // åªä¿ç•™æœ€è¿‘10æ¡
            if (history.length > 10) {
                history = history.slice(-10);
            }
            
            // ä¿å­˜æ•°æ®
            saveData();
            
            // æ›´æ–°ç•Œé¢
            showResult(selected);
            updateHistory();
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(restaurant) {
            const resultBox = document.getElementById('resultBox');
            const resultName = document.getElementById('resultName');
            const resultTags = document.getElementById('resultTags');
            
            resultName.textContent = restaurant.name;
            resultTags.innerHTML = restaurant.tags.map(tag => 
                `<span class="tag" style="margin: 3px; background: rgba(255,255,255,0.3);">${tag}</span>`
            ).join('');
            
            resultBox.style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœä½ç½®
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = history.slice().reverse().map(item => `
                <div class="history-item">
                    <span>${item.name}</span>
                    <span class="history-time">${item.time}</span>
                </div>
            `).join('');
        }
        
        // ========== åˆå§‹åŒ– ==========
        
        function init() {
            console.log("åˆå§‹åŒ–åº”ç”¨");
            
            // åŠ è½½æ•°æ®
            loadData();
            
            // åˆå§‹åŒ–ç•Œé¢
            initTags();
            updateHistory();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('decideButton').onclick = pickRandom;
            
            // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡é€‰æ‹©ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            setTimeout(() => {
                if (history.length === 0) {
                    console.log("è‡ªåŠ¨è¿è¡Œæ¼”ç¤ºé€‰æ‹©");
                    pickRandom();
                }
            }, 1000);
            
            console.log("åˆå§‹åŒ–å®Œæˆ");
            console.log("é¤å…æ•°é‡:", restaurants.length);
            console.log("å†å²è®°å½•:", history.length);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        // è°ƒè¯•å‡½æ•°
        window.debugInfo = function() {
            return {
                restaurants: restaurants,
                selectedTags: selectedTags,
                history: history
            };
        };
    </script>
</body>
</html>
